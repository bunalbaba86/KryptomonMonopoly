<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kryptomon Monopoly - Perfect Edition</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
  color: #fff;
  min-height: 100vh;
  overflow-x: hidden;
}

.container {
  max-width: 1600px;
  margin: 0 auto;
  padding: 20px;
}

h1 {
  text-align: center;
  color: #00f5ff;
  font-size: 3rem;
  margin-bottom: 30px;
  text-shadow: 0 0 30px #00f5ff;
  animation: titleGlow 2s ease-in-out infinite alternate;
  font-weight: 900;
}

@keyframes titleGlow {
  from { text-shadow: 0 0 30px #00f5ff; }
  to { text-shadow: 0 0 50px #00f5ff; }
}

/* Menu */
.menu {
  text-align: center;
  padding: 80px 0;
  background: rgba(26, 26, 46, 0.3);
  border-radius: 30px;
  backdrop-filter: blur(10px);
  border: 2px solid rgba(0, 245, 255, 0.3);
}

.menu button {
  background: linear-gradient(45deg, #00f5ff, #0080ff);
  border: none;
  padding: 20px 40px;
  margin: 15px;
  font-size: 20px;
  color: white;
  border-radius: 50px;
  cursor: pointer;
  transition: all 0.4s ease;
  box-shadow: 0 8px 30px rgba(0, 245, 255, 0.4);
  font-weight: bold;
}

.menu button:hover {
  transform: translateY(-5px) scale(1.05);
  box-shadow: 0 15px 40px rgba(0, 245, 255, 0.6);
}

/* Game Layout */
.game-container {
  display: none;
}

.game-layout {
  display: grid;
  grid-template-columns: 300px 700px 300px;
  gap: 30px;
  align-items: start;
  max-width: 1400px;
  margin: 0 auto;
}

.left-panel, .right-panel {
  background: linear-gradient(145deg, rgba(26, 26, 46, 0.9), rgba(22, 33, 62, 0.9));
  border-radius: 25px;
  padding: 25px;
  border: 3px solid rgba(0, 245, 255, 0.3);
  backdrop-filter: blur(15px);
}

/* Player Panels */
.player-panel {
  background: linear-gradient(145deg, rgba(26, 26, 46, 0.95), rgba(22, 33, 62, 0.95));
  border-radius: 20px;
  padding: 25px;
  margin-bottom: 25px;
  border: 3px solid rgba(0, 245, 255, 0.2);
  transition: all 0.5s ease;
  text-align: center;
  backdrop-filter: blur(10px);
}

.player-panel.active {
  border-color: #00f5ff;
  box-shadow: 0 0 40px rgba(0, 245, 255, 0.5);
  transform: scale(1.02);
}

.player-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 4px solid #00f5ff;
  background-size: cover;
  background-position: center;
  margin: 0 auto 15px;
  box-shadow: 0 0 20px rgba(0, 245, 255, 0.5);
}

.player-avatar.player { background-image: url('character.png'); }
.player-avatar.cpu { background-image: url('character2.png'); }

.player-name {
  font-size: 24px;
  font-weight: bold;
  margin-bottom: 10px;
  color: #00f5ff;
}

.player-money {
  font-size: 28px;
  color: #2ed573;
  margin-bottom: 10px;
  font-weight: bold;
}

.player-properties {
  font-size: 16px;
  color: #ccc;
}

/* Game Board */
.board-container {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.board {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  grid-template-rows: repeat(5, 1fr);
  gap: 3px;
  width: 700px;
  height: 700px;
  background: linear-gradient(45deg, #0f1419, #1a1a2e);
  border: 6px solid #00f5ff;
  border-radius: 20px;
  padding: 15px;
  box-shadow: 0 0 50px rgba(0, 245, 255, 0.6);
  margin-bottom: 30px;
}

.cell {
  background: linear-gradient(145deg, rgba(26, 26, 46, 0.95), rgba(22, 33, 62, 0.95));
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  padding: 8px;
  position: relative;
  border: 2px solid rgba(0, 245, 255, 0.2);
  transition: all 0.3s ease;
}

.cell.empty {
  background: transparent;
  border: none;
}

.cell:not(.empty):hover {
  border-color: #00f5ff;
  box-shadow: 0 0 20px rgba(0, 245, 255, 0.5);
  transform: scale(1.02);
}

.cell-name {
  font-size: 11px;
  font-weight: bold;
  text-align: center;
  color: #fff;
  line-height: 1.1;
  margin-bottom: 5px;
  text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
}

.cell-rent {
  background: linear-gradient(45deg, #00f5ff, #0080ff);
  color: #000;
  padding: 2px 6px;
  border-radius: 6px;
  font-size: 9px;
  font-weight: bold;
  margin-top: auto;
}

.cell-building {
  font-size: 12px;
  margin-top: 2px;
  text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
}

.owner-tag {
  position: absolute;
  top: 3px;
  right: 3px;
  padding: 1px 4px;
  border-radius: 6px;
  font-size: 8px;
  font-weight: bold;
}

.owner-player { background: #ff4757; color: #fff; }
.owner-cpu { background: #2ed573; color: #000; }

.player-token {
  position: absolute;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  border: 3px solid #fff;
  transition: all 0.8s ease;
  z-index: 15;
  background-size: cover;
  background-position: center;
  box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
}

.token-player {
  background-image: url('kryptomon.png');
  bottom: 5px;
  left: 5px;
  border-color: #00f5ff;
}

.token-cpu {
  background-image: url('kryptomon2.png');
  bottom: 5px;
  right: 5px;
  border-color: #2ed573;
}

/* START cell special styling */
.cell.start {
  background: linear-gradient(145deg, #32cd32, #228b22) !important;
  color: #fff !important;
  border: 4px solid #32cd32 !important;
  box-shadow: 0 0 30px rgba(50, 205, 50, 1) !important;
}

.cell.start .cell-name {
  color: #fff !important;
  font-size: 14px !important;
  font-weight: 900 !important;
  text-shadow: 0 0 20px rgba(255, 255, 255, 1) !important;
}

.cell.start .player-token {
  border-width: 4px !important;
  box-shadow: 0 0 25px rgba(255, 255, 255, 1) !important;
  z-index: 25 !important;
}

/* Other special cells */
.cell.jail {
  background: linear-gradient(145deg, #dc143c, #b22222);
  color: #fff;
  border-color: #b22222;
}

.cell.tax {
  background: linear-gradient(145deg, #ff69b4, #ff1493);
  color: #fff;
  border-color: #ff1493;
}

.cell.chance {
  background: linear-gradient(145deg, #9932cc, #8b008b);
  color: #fff;
  border-color: #8b008b;
}

/* Dice Section */
.dice-section {
  display: flex;
  gap: 20px;
  align-items: center;
  justify-content: center;
  margin-bottom: 30px;
  padding: 20px;
  background: rgba(26, 26, 46, 0.3);
  border-radius: 25px;
  backdrop-filter: blur(10px);
  border: 2px solid rgba(0, 245, 255, 0.3);
}

.dice {
  width: 70px;
  height: 70px;
  background: linear-gradient(45deg, #00f5ff, #0080ff);
  border-radius: 15px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  font-weight: bold;
  color: white;
  cursor: pointer;
  transition: all 0.4s ease;
  box-shadow: 0 8px 25px rgba(0, 245, 255, 0.4);
  border: 3px solid #fff;
}

.dice:hover {
  transform: scale(1.1);
}

.dice.rolling {
  animation: roll 0.6s ease-in-out;
}

@keyframes roll {
  0% { transform: rotate(0deg) scale(1); }
  50% { transform: rotate(180deg) scale(1.3); }
  100% { transform: rotate(360deg) scale(1); }
}

.roll-btn {
  background: linear-gradient(45deg, #ff6b6b, #ff8e53);
  border: none;
  padding: 15px 30px;
  color: white;
  border-radius: 25px;
  font-size: 18px;
  cursor: pointer;
  transition: all 0.4s ease;
  box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
  margin-left: 20px;
  font-weight: bold;
}

.roll-btn:hover:not(:disabled) {
  transform: translateY(-3px) scale(1.05);
  box-shadow: 0 15px 40px rgba(255, 107, 107, 0.6);
}

.roll-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Purchase Panel */
.purchase-panel {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: linear-gradient(145deg, rgba(26, 26, 46, 0.98), rgba(22, 33, 62, 0.98));
  border: 3px solid #00f5ff;
  border-radius: 25px;
  padding: 30px;
  z-index: 2000;
  display: none;
  min-width: 600px;
  backdrop-filter: blur(20px);
  box-shadow: 0 0 50px rgba(0, 245, 255, 0.6);
  text-align: center;
}

.purchase-title {
  font-size: 28px;
  color: #00f5ff;
  margin-bottom: 20px;
  font-weight: bold;
}

.property-details {
  background: rgba(0, 0, 0, 0.4);
  padding: 15px;
  border-radius: 10px;
  margin: 15px 0;
  text-align: left;
  border: 1px solid rgba(0, 245, 255, 0.2);
}

.upgrade-options {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
  margin: 20px 0;
}

.upgrade-btn {
  background: linear-gradient(45deg, #ffa500, #ff8c00);
  border: none;
  padding: 15px 10px;
  color: white;
  border-radius: 12px;
  cursor: pointer;
  font-size: 12px;
  font-weight: bold;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(255, 165, 0, 0.3);
  min-height: 80px;
}

.upgrade-btn:hover:not(:disabled) {
  transform: scale(1.05);
  box-shadow: 0 8px 25px rgba(255, 165, 0, 0.5);
}

.upgrade-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.hotel-btn {
  background: linear-gradient(45deg, #ff1493, #dc143c);
}

.purchase-from-opponent {
  background: linear-gradient(45deg, #8b00ff, #4b0082);
  grid-column: 1 / -1;
  margin-top: 10px;
}

.skip-btn {
  background: linear-gradient(45deg, #666, #888);
  margin-top: 15px;
  padding: 12px 25px;
  font-size: 16px;
  border-radius: 20px;
  border: none;
  color: white;
  cursor: pointer;
  transition: all 0.3s ease;
}

/* Message Box */
.message-box {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: linear-gradient(145deg, rgba(26, 26, 46, 0.98), rgba(22, 33, 62, 0.98));
  border: 3px solid #00f5ff;
  border-radius: 20px;
  padding: 25px 35px;
  color: #fff;
  font-size: 18px;
  text-align: center;
  z-index: 2500;
  display: none;
  backdrop-filter: blur(15px);
  box-shadow: 0 0 50px rgba(0, 245, 255, 0.6);
  max-width: 500px;
  min-width: 300px;
}

/* Game Info */
.game-info {
  text-align: center;
  font-size: 20px;
  margin: 20px 0;
  color: #00f5ff;
  font-weight: bold;
  padding: 10px 20px;
  background: rgba(26, 26, 46, 0.3);
  border-radius: 15px;
  border: 2px solid rgba(0, 245, 255, 0.3);
  backdrop-filter: blur(10px);
}

.back-btn {
  background: linear-gradient(45deg, #666, #888);
  border: none;
  padding: 12px 25px;
  color: white;
  border-radius: 20px;
  cursor: pointer;
  margin: 20px auto;
  display: block;
  font-size: 16px;
  font-weight: bold;
  transition: all 0.3s ease;
}

.close-btn {
  background: #ff4757;
  border: none;
  padding: 8px 15px;
  color: white;
  border-radius: 10px;
  cursor: pointer;
  float: right;
  margin-bottom: 15px;
  font-weight: bold;
}

/* Other panels */
.chance-card, .jail-panel {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  border-radius: 20px;
  padding: 30px;
  z-index: 2000;
  display: none;
  min-width: 400px;
  text-align: center;
  backdrop-filter: blur(15px);
}

.chance-card {
  background: linear-gradient(145deg, rgba(153, 50, 204, 0.95), rgba(139, 0, 139, 0.95));
  border: 3px solid #ffd700;
  box-shadow: 0 0 50px rgba(255, 215, 0, 0.4);
}

.jail-panel {
  background: linear-gradient(145deg, rgba(220, 20, 60, 0.95), rgba(178, 34, 34, 0.95));
  border: 3px solid #fff;
  box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
  color: #fff;
}

.jail-buttons {
  display: flex;
  gap: 15px;
  justify-content: center;
  margin-top: 20px;
}

.jail-btn {
  background: linear-gradient(45deg, #ffa500, #ff8c00);
  border: none;
  padding: 12px 20px;
  color: white;
  border-radius: 12px;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.3s ease;
  font-weight: bold;
}

.jail-btn:hover {
  transform: scale(1.05);
}
</style>
</head>
<body>

<div class="container">
  <h1>🐉 KRYPTOMON MONOPOLY 🐉</h1>
  
  <!-- Menu Screen -->
  <div id="menu" class="menu">
    <button onclick="startGame()">🎮 Start Game</button>
    <button onclick="showRules()">📖 How to Play</button>
    <button onclick="exitGame()">❌ Exit</button>
  </div>

  <!-- Game Screen -->
  <div id="game" class="game-container">
    <div class="game-layout">
      <!-- Left Panel -->
      <div class="left-panel">
        <div id="playerPanel" class="player-panel">
          <div class="player-avatar player"></div>
          <div class="player-name">👤 YOU</div>
          <div class="player-money">💰 $<span id="playerMoney">1500</span></div>
          <div class="player-properties">Properties: <span id="playerProps">0</span></div>
        </div>
      </div>

      <!-- Center - Game Board -->
      <div class="board-container">
        <div id="board" class="board"></div>
        
        <div class="dice-section">
          <div id="dice1" class="dice">1</div>
          <div id="dice2" class="dice">1</div>
          <button id="rollBtn" class="roll-btn" onclick="rollDice()">🎲 ROLL DICE</button>
        </div>

        <div id="gameInfo" class="game-info">Your Turn - Roll the Dice!</div>
      </div>

      <!-- Right Panel -->
      <div class="right-panel">
        <div id="cpuPanel" class="player-panel">
          <div class="player-avatar cpu"></div>
          <div class="player-name">🤖 CPU</div>
          <div class="player-money">💰 $<span id="cpuMoney">1500</span></div>
          <div class="player-properties">Properties: <span id="cpuProps">0</span></div>
        </div>
      </div>
    </div>

    <button class="back-btn" onclick="backToMenu()">← Back to Menu</button>
  </div>

  <!-- Purchase Panel -->
  <div id="purchasePanel" class="purchase-panel">
    <button class="close-btn" onclick="closePurchasePanel()">✕</button>
    <div class="purchase-title">Property Options</div>
    <div class="property-details">
      <p><strong>Property:</strong> <span id="propertyName">-</span></p>
      <p><strong>Price:</strong> $<span id="propertyPrice">0</span></p>
      <p><strong>Current Rent:</strong> $<span id="currentRentDisplay">0</span></p>
    </div>
    <div class="upgrade-options" id="upgradeOptions">
      <button class="upgrade-btn" id="buyBtn" onclick="buyProperty()">Buy Property<br>$<span id="buyPrice">0</span></button>
      <button class="upgrade-btn" onclick="upgradeProperty(1)">Level 1 🏠<br>$50<br>Rent: $<span id="rent1">0</span></button>
      <button class="upgrade-btn" onclick="upgradeProperty(2)">Level 2 🏠🏠<br>$100<br>Rent: $<span id="rent2">0</span></button>
      <button class="upgrade-btn" onclick="upgradeProperty(3)">Level 3 🏠🏠🏠<br>$150<br>Rent: $<span id="rent3">0</span></button>
      <button class="upgrade-btn" onclick="upgradeProperty(4)">Level 4 🏠🏠🏠🏠<br>$200<br>Rent: $<span id="rent4">0</span></button>
      <button class="upgrade-btn hotel-btn" onclick="buildHotel()">Hotel 🏨<br>$300<br>Rent: $<span id="rentHotel">0</span></button>
      <button class="upgrade-btn purchase-from-opponent" id="purchaseFromOpponent" onclick="purchaseFromOpponent()" style="display: none;">Buy from Opponent<br>$<span id="opponentPrice">0</span></button>
    </div>
    <button class="skip-btn" onclick="skipPurchase()">Skip</button>
  </div>

  <!-- Chance Card -->
  <div id="chanceCard" class="chance-card">
    <h2>🎲 CHANCE 🎲</h2>
    <div id="chanceText"></div>
    <button class="jail-btn" onclick="closeChanceCard()" style="margin-top: 20px;">OK</button>
  </div>

  <!-- Jail Panel -->
  <div id="jailPanel" class="jail-panel">
    <h2>🔒 JAIL 🔒</h2>
    <div id="jailText">You are in jail!</div>
    <div class="jail-buttons">
      <button class="jail-btn" onclick="payJailFine()">Pay $50 Fine</button>
      <button class="jail-btn" onclick="tryJailRoll()">Try Double Roll</button>
    </div>
  </div>

  <!-- Message Box -->
  <div id="messageBox" class="message-box"></div>
</div>

<script>
// Game State
let gameState = {
  currentPlayer: 0,
  players: [
    { 
      name: 'You', 
      money: 1500, 
      position: 0, 
      properties: {}, 
      bankrupt: false, 
      inJail: false, 
      jailTurns: 0,
      jailFreeCard: false
    },
    { 
      name: 'CPU', 
      money: 1500, 
      position: 0, 
      properties: {}, 
      bankrupt: false, 
      inJail: false, 
      jailTurns: 0,
      jailFreeCard: false
    }
  ],
  gameStarted: false,
  canRoll: true,
  lastRoll: [0, 0],
  waitingForPlayer: false
};

// Perfect 5x5 square board (16 positions)
const boardPositions = [
  // Bottom row (0-4)
  { name: 'START', type: 'start', price: 0, baseRent: 0 },
  { name: 'Aelum Valley', type: 'property', price: 100, baseRent: 20 },
  { name: 'CHANCE', type: 'chance', price: 0, baseRent: 0 },
  { name: 'Sha Mountains', type: 'property', price: 120, baseRent: 25 },
  { name: 'JAIL', type: 'jail', price: 0, baseRent: 0 },
  
  // Right column (5-7)
  { name: 'Oura Canyon', type: 'property', price: 140, baseRent: 30 },
  { name: 'TAX', type: 'tax', price: 0, baseRent: 0 },
  { name: 'Ukko Desert', type: 'property', price: 160, baseRent: 35 },
  
  // Top row (8-11)
  { name: 'FREE PARKING', type: 'special', price: 0, baseRent: 0 },
  { name: 'Haamu Peaks', type: 'property', price: 180, baseRent: 40 },
  { name: 'CHANCE', type: 'chance', price: 0, baseRent: 0 },
  { name: 'Bosco Valley', type: 'property', price: 200, baseRent: 45 },
  
  // Left column (12-15)
  { name: 'Mystic Woods', type: 'property', price: 220, baseRent: 50 },
  { name: 'Cryonia', type: 'property', price: 240, baseRent: 55 },
  { name: 'TAX', type: 'tax', price: 0, baseRent: 0 },
  { name: 'Thunder Peak', type: 'property', price: 280, baseRent: 65 }
];

// Chance cards
const chanceCards = [
  { text: "Get out of jail free! Keep this card.", effect: "jailFree" },
  { text: "Collect $200 from bank!", effect: "collect200" },
  { text: "Go to jail! Do not pass START.", effect: "goToJail" },
  { text: "Advance to START! Collect $200.", effect: "goToStart" },
  { text: "Pay $50 tax!", effect: "pay50" },
  { text: "Collect $100 bonus!", effect: "collect100" }
];

function initGame() {
  createBoard();
  updateDisplay();
  updateGameInfo();
}

function createBoard() {
  const board = document.getElementById('board');
  board.innerHTML = '';
  
  // 5x5 grid (25 cells total, 16 used for board)
  for (let i = 0; i < 25; i++) {
    const cell = document.createElement('div');
    cell.className = 'cell';
    
    const boardIndex = getBoardIndex(i);
    
    if (boardIndex !== -1) {
      const position = boardPositions[boardIndex];
      
      if (position.type === 'start') cell.classList.add('start');
      else if (position.type === 'jail') cell.classList.add('jail');
      else if (position.type === 'chance') cell.classList.add('chance');
      else if (position.type === 'tax') cell.classList.add('tax');
      
      cell.innerHTML = `<div class="cell-name">${position.name}</div>`;
      cell.dataset.position = boardIndex;
      
      if (position.type === 'property') {
        const rentDiv = document.createElement('div');
        rentDiv.className = 'cell-rent';
        rentDiv.textContent = `$${position.baseRent}`;
        cell.appendChild(rentDiv);
      }
    } else {
      cell.classList.add('empty');
    }
    
    board.appendChild(cell);
  }
  
  updateTokens();
  updatePropertyDisplay();
}

function getBoardIndex(gridIndex) {
  // Perfect 5x5 square mapping
  const gridToBoardMap = {
    // Bottom row (0-4)
    0: 0, 1: 1, 2: 2, 3: 3, 4: 4,
    // Right column (5-7) 
    9: 5, 14: 6, 19: 7,
    // Top row (8-11)
    24: 8, 23: 9, 22: 10, 21: 11,
    // Left column (12-15)
    20: 12, 15: 13, 10: 14, 5: 15
  };
  
  return gridToBoardMap[gridIndex] || -1;
}

function getGridPosition(boardPosition) {
  const boardToGridMap = {
    0: 0, 1: 1, 2: 2, 3: 3, 4: 4,
    5: 9, 6: 14, 7: 19,
    8: 24, 9: 23, 10: 22, 11: 21,
    12: 20, 13: 15, 14: 10, 15: 5
  };
  return boardToGridMap[boardPosition] || -1;
}

function updateTokens() {
  document.querySelectorAll('.player-token').forEach(token => token.remove());
  
  gameState.players.forEach((player, index) => {
    if (!player.bankrupt) {
      const cell = document.querySelector(`[data-position="${player.position}"]`);
      if (cell) {
        const token = document.createElement('div');
        token.className = `player-token token-${index === 0 ? 'player' : 'cpu'}`;
        cell.appendChild(token);
      }
    }
  });
}

function updatePropertyDisplay() {
  boardPositions.forEach((position, index) => {
    if (position.type === 'property') {
      const cell = document.querySelector(`[data-position="${index}"]`);
      if (cell) {
        // Remove old displays
        const oldOwner = cell.querySelector('.owner-tag');
        const oldBuilding = cell.querySelector('.cell-building');
        const oldRent = cell.querySelector('.cell-rent');
        
        if (oldOwner) oldOwner.remove();
        if (oldBuilding) oldBuilding.remove();
        if (oldRent) oldRent.remove();
        
        const propertyData = getPropertyData(index);
        
        // Add rent display
        const rentDiv = document.createElement('div');
        rentDiv.className = 'cell-rent';
        rentDiv.textContent = `$${calculateRent(index)}`;
        cell.appendChild(rentDiv);
        
        if (propertyData.owner !== undefined) {
          // Add owner tag
          const ownerTag = document.createElement('div');
          ownerTag.className = `owner-tag owner-${propertyData.owner === 0 ? 'player' : 'cpu'}`;
          ownerTag.textContent = propertyData.owner === 0 ? 'P' : 'C';
          cell.appendChild(ownerTag);
          
          // Add building display
          if (propertyData.level > 0) {
            const building = document.createElement('div');
            building.className = 'cell-building';
            if (propertyData.hotel) {
              building.textContent = '🏨';
            } else {
              building.textContent = '🏠'.repeat(propertyData.level);
            }
            cell.appendChild(building);
          }
        }
      }
    }
  });
}

function getPropertyData(positionIndex) {
  for (let i = 0; i < gameState.players.length; i++) {
    if (gameState.players[i].properties[positionIndex]) {
      return gameState.players[i].properties[positionIndex];
    }
  }
  return { owner: undefined, level: 0, hotel: false };
}

function calculateRent(positionIndex) {
  const position = boardPositions[positionIndex];
  const propertyData = getPropertyData(positionIndex);
  
  if (propertyData.owner === undefined) {
    return position.baseRent;
  }
  
  let rent = position.baseRent;
  
  if (propertyData.hotel) {
    rent = position.baseRent * 8; // Hotel multiplier
  } else if (propertyData.level > 0) {
    rent = position.baseRent * (1 + propertyData.level); // Level multiplier
  }
  
  return rent;
}

function startGame() {
  document.getElementById('menu').style.display = 'none';
  document.getElementById('game').style.display = 'block';
  gameState.gameStarted = true;
  initGame();
  showMessage('Game Started! Roll the dice to begin!');
}

function backToMenu() {
  document.getElementById('game').style.display = 'none';
  document.getElementById('menu').style.display = 'block';
  resetGame();
}

function resetGame() {
  gameState = {
    currentPlayer: 0,
    players: [
      { 
        name: 'You', 
        money: 1500, 
        position: 0, 
        properties: {}, 
        bankrupt: false, 
        inJail: false, 
        jailTurns: 0,
        jailFreeCard: false
      },
      { 
        name: 'CPU', 
        money: 1500, 
        position: 0, 
        properties: {}, 
        bankrupt: false, 
        inJail: false, 
        jailTurns: 0,
        jailFreeCard: false
      }
    ],
    gameStarted: false,
    canRoll: true,
    lastRoll: [0, 0],
    waitingForPlayer: false
  };
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function rollDice() {
  if (!gameState.canRoll || gameState.waitingForPlayer) return;
  
  const currentPlayer = gameState.players[gameState.currentPlayer];
  
  if (currentPlayer.inJail) {
    showJailPanel();
    return;
  }
  
  gameState.canRoll = false;
  const dice1 = document.getElementById('dice1');
  const dice2 = document.getElementById('dice2');
  const rollBtn = document.getElementById('rollBtn');
  
  dice1.classList.add('rolling');
  dice2.classList.add('rolling');
  rollBtn.disabled = true;
  
  let d1, d2;
  for (let i = 0; i < 8; i++) {
    d1 = Math.floor(Math.random() * 6) + 1;
    d2 = Math.floor(Math.random() * 6) + 1;
    dice1.textContent = d1;
    dice2.textContent = d2;
    await sleep(100);
  }
  
  gameState.lastRoll = [d1, d2];
  const rollResult = d1 + d2;
  
  dice1.classList.remove('rolling');
  dice2.classList.remove('rolling');
  
  updateGameInfo(`${currentPlayer.name} rolled ${d1} + ${d2} = ${rollResult}`);
  
  await movePlayer(gameState.currentPlayer, rollResult);
  await handleLanding();
  
  if (!gameState.waitingForPlayer) {
    nextTurn();
  }
}

async function movePlayer(playerIndex, steps) {
  const player = gameState.players[playerIndex];
  const startPos = player.position;
  
  for (let i = 0; i < steps; i++) {
    player.position = (player.position + 1) % boardPositions.length;
    updateTokens();
    await sleep(200);
  }
  
  // Check if passed START
  if (startPos + steps >= boardPositions.length || (startPos > player.position && steps < boardPositions.length)) {
    player.money += 200;
    showMessage(`${player.name} passed START and collected $200!`);
    await sleep(1000);
  }
}

async function handleLanding() {
  const player = gameState.players[gameState.currentPlayer];
  const position = boardPositions[player.position];
  
  updateDisplay();
  
  if (position.type === 'property') {
    await handlePropertyLanding(player, player.position, position);
  } else if (position.type === 'chance') {
    await handleChanceLanding();
  } else if (position.type === 'tax') {
    player.money -= 100;
    showMessage(`${player.name} paid $100 tax!`);
    await sleep(1500);
  }
  
  updateDisplay();
}

async function handlePropertyLanding(player, positionIndex, position) {
  const propertyData = getPropertyData(positionIndex);
  
  if (propertyData.owner === undefined) {
    // Property available for purchase
    if (gameState.currentPlayer === 0) {
      // Human player
      gameState.waitingForPlayer = true;
      showPurchasePanel(positionIndex, position, true);
    } else {
      // CPU player - auto decide (hidden from player)
      if (player.money >= position.price * 1.2) {
        await sleep(1000);
        buyPropertyCPU(positionIndex);
        showMessage(`CPU bought ${position.name} for $${position.price}!`);
        await sleep(2000);
        
        // CPU might upgrade immediately
        if (player.money >= 150 && Math.random() > 0.4) {
          await sleep(500);
          upgradePropertyCPU(positionIndex, 1);
          showMessage(`CPU upgraded ${position.name} to Level 1!`);
          await sleep(1500);
        }
      }
    }
  } else if (propertyData.owner !== gameState.currentPlayer) {
    // Pay rent
    const rent = calculateRent(positionIndex);
    if (player.money >= rent) {
      player.money -= rent;
      gameState.players[propertyData.owner].money += rent;
      showMessage(`${player.name} paid $${rent} rent to ${gameState.players[propertyData.owner].name}!`);
      await sleep(2000);
    } else {
      showMessage(`${player.name} cannot afford rent! Game Over!`);
      player.bankrupt = true;
      await sleep(2000);
    }
  } else {
    // Own property - show upgrade options for human player
    if (gameState.currentPlayer === 0) {
      gameState.waitingForPlayer = true;
      showPurchasePanel(positionIndex, position, false);
    }
  }
}

async function handleChanceLanding() {
  const card = chanceCards[Math.floor(Math.random() * chanceCards.length)];
  const player = gameState.players[gameState.currentPlayer];
  
  document.getElementById('chanceText').textContent = card.text;
  document.getElementById('chanceCard').style.display = 'block';
  
  // Wait for user to close card
  await new Promise(resolve => {
    window.closeChanceCard = () => {
      document.getElementById('chanceCard').style.display = 'none';
      resolve();
    };
  });
  
  // Apply effect
  switch (card.effect) {
    case 'jailFree':
      player.jailFreeCard = true;
      break;
    case 'collect200':
      player.money += 200;
      break;
    case 'goToJail':
      player.inJail = true;
      player.position = 4; // Jail position
      player.jailTurns = 0;
      updateTokens();
      break;
    case 'goToStart':
      player.position = 0;
      player.money += 200;
      updateTokens();
      break;
    case 'pay50':
      player.money -= 50;
      break;
    case 'collect100':
      player.money += 100;
      break;
  }
  
  await sleep(1000);
}

function showPurchasePanel(positionIndex, position, canBuy) {
  const propertyData = getPropertyData(positionIndex);
  const currentRent = calculateRent(positionIndex);
  
  document.getElementById('propertyName').textContent = position.name;
  document.getElementById('propertyPrice').textContent = position.price;
  document.getElementById('currentRentDisplay').textContent = currentRent;
  
  // Hide all buttons first
  document.getElementById('buyBtn').style.display = 'none';
  document.getElementById('purchaseFromOpponent').style.display = 'none';
  document.querySelectorAll('.upgrade-btn:not(#buyBtn):not(#purchaseFromOpponent)').forEach(btn => {
    btn.style.display = 'none';
  });
  
  if (canBuy && propertyData.owner === undefined) {
    // Show buy button only
    document.getElementById('buyBtn').style.display = 'block';
    document.getElementById('buyPrice').textContent = position.price;
  } else if (propertyData.owner !== undefined && propertyData.owner !== gameState.currentPlayer) {
    // Show purchase from opponent
    const opponentPrice = Math.floor(position.price * 1.5);
    document.getElementById('purchaseFromOpponent').style.display = 'block';
    document.getElementById('opponentPrice').textContent = opponentPrice;
  } else if (propertyData.owner === gameState.currentPlayer) {
    // Show upgrade options
    document.querySelectorAll('.upgrade-btn:not(#buyBtn):not(#purchaseFromOpponent)').forEach(btn => {
      btn.style.display = 'block';
    });
    
    // Update rent displays
    document.getElementById('rent1').textContent = position.baseRent * 2;
    document.getElementById('rent2').textContent = position.baseRent * 3;
    document.getElementById('rent3').textContent = position.baseRent * 4;
    document.getElementById('rent4').textContent = position.baseRent * 5;
    document.getElementById('rentHotel').textContent = position.baseRent * 8;
    
    // Disable completed upgrades
    if (propertyData.level >= 1) document.querySelector('[onclick="upgradeProperty(1)"]').disabled = true;
    if (propertyData.level >= 2) document.querySelector('[onclick="upgradeProperty(2)"]').disabled = true;
    if (propertyData.level >= 3) document.querySelector('[onclick="upgradeProperty(3)"]').disabled = true;
    if (propertyData.level >= 4) document.querySelector('[onclick="upgradeProperty(4)"]').disabled = true;
    if (propertyData.hotel) document.querySelector('[onclick="buildHotel()"]').disabled = true;
    if (propertyData.level < 4) document.querySelector('[onclick="buildHotel()"]').disabled = true;
  }
  
  document.getElementById('purchasePanel').style.display = 'block';
}

function buyProperty() {
  const player = gameState.players[gameState.currentPlayer];
  const positionIndex = player.position;
  const position = boardPositions[positionIndex];
  
  if (player.money >= position.price) {
    player.money -= position.price;
    player.properties[positionIndex] = {
      owner: gameState.currentPlayer,
      level: 0,
      hotel: false
    };
    
    showMessage(`You bought ${position.name} for $${position.price}!`);
    closePurchasePanel();
    updateDisplay();
    updatePropertyDisplay();
    
    gameState.waitingForPlayer = false;
    setTimeout(nextTurn, 1500);
  } else {
    showMessage('Not enough money!');
  }
}

function buyPropertyCPU(positionIndex) {
  const player = gameState.players[1]; // CPU
  const position = boardPositions[positionIndex];
  
  player.money -= position.price;
  player.properties[positionIndex] = {
    owner: 1,
    level: 0,
    hotel: false
  };
  
  updateDisplay();
  updatePropertyDisplay();
}

function upgradeProperty(level) {
  const player = gameState.players[gameState.currentPlayer];
  const positionIndex = player.position;
  const cost = level * 50;
  
  if (player.money >= cost) {
    player.money -= cost;
    player.properties[positionIndex].level = level;
    
    showMessage(`Upgraded to Level ${level}!`);
    closePurchasePanel();
    updateDisplay();
    updatePropertyDisplay();
    
    gameState.waitingForPlayer = false;
    setTimeout(nextTurn, 1500);
  } else {
    showMessage('Not enough money!');
  }
}

function upgradePropertyCPU(positionIndex, level) {
  const player = gameState.players[1]; // CPU
  const cost = level * 50;
  
  player.money -= cost;
  player.properties[positionIndex].level = level;
  
  updateDisplay();
  updatePropertyDisplay();
}

function buildHotel() {
  const player = gameState.players[gameState.currentPlayer];
  const positionIndex = player.position;
  const cost = 300;
  
  if (player.money >= cost && player.properties[positionIndex].level === 4) {
    player.money -= cost;
    player.properties[positionIndex].hotel = true;
    
    showMessage('Hotel built!');
    closePurchasePanel();
    updateDisplay();
    updatePropertyDisplay();
    
    gameState.waitingForPlayer = false;
    setTimeout(nextTurn, 1500);
  } else {
    showMessage('Need Level 4 property and $300!');
  }
}

function purchaseFromOpponent() {
  const player = gameState.players[gameState.currentPlayer];
  const positionIndex = player.position;
  const position = boardPositions[positionIndex];
  const cost = Math.floor(position.price * 1.5);
  const propertyData = getPropertyData(positionIndex);
  
  if (player.money >= cost) {
    player.money -= cost;
    
    // Remove from opponent
    delete gameState.players[propertyData.owner].properties[positionIndex];
    
    // Add to current player
    player.properties[positionIndex] = {
      owner: gameState.currentPlayer,
      level: 0,
      hotel: false
    };
    
    showMessage(`Bought ${position.name} from opponent for $${cost}!`);
    closePurchasePanel();
    updateDisplay();
    updatePropertyDisplay();
    
    gameState.waitingForPlayer = false;
    setTimeout(nextTurn, 1500);
  } else {
    showMessage('Not enough money!');
  }
}

function skipPurchase() {
  closePurchasePanel();
  gameState.waitingForPlayer = false;
  setTimeout(nextTurn, 500);
}

function closePurchasePanel() {
  document.getElementById('purchasePanel').style.display = 'none';
}

function showJailPanel() {
  const player = gameState.players[gameState.currentPlayer];
  
  if (gameState.currentPlayer === 0) {
    // Human player
    document.getElementById('jailText').textContent = `You are in jail! (Turn ${player.jailTurns + 1}/3)`;
    document.getElementById('jailPanel').style.display = 'block';
  } else {
    // CPU auto-decides
    if (player.money >= 50 && Math.random() > 0.3) {
      payJailFineCPU();
    } else {
      tryJailRollCPU();
    }
  }
}

function payJailFine() {
  const player = gameState.players[gameState.currentPlayer];
  
  if (player.money >= 50) {
    player.money -= 50;
    player.inJail = false;
    player.jailTurns = 0;
    
    document.getElementById('jailPanel').style.display = 'none';
    showMessage('Paid jail fine! You are free!');
    
    updateDisplay();
    setTimeout(() => {
      gameState.canRoll = true;
      document.getElementById('rollBtn').disabled = false;
    }, 1500);
  } else {
    showMessage('Not enough money for fine!');
  }
}

function payJailFineCPU() {
  const player = gameState.players[1];
  
  player.money -= 50;
  player.inJail = false;
  player.jailTurns = 0;
  
  showMessage('CPU paid jail fine and is free!');
  updateDisplay();
  
  setTimeout(() => {
    rollDice(); // CPU continues turn
  }, 1500);
}

async function tryJailRoll() {
  document.getElementById('jailPanel').style.display = 'none';
  
  const player = gameState.players[gameState.currentPlayer];
  const dice1 = Math.floor(Math.random() * 6) + 1;
  const dice2 = Math.floor(Math.random() * 6) + 1;
  
  document.getElementById('dice1').textContent = dice1;
  document.getElementById('dice2').textContent = dice2;
  
  if (dice1 === dice2) {
    // Rolled doubles - free!
    player.inJail = false;
    player.jailTurns = 0;
    showMessage(`Rolled doubles (${dice1}-${dice2})! You are free!`);
    
    await sleep(1500);
    await movePlayer(gameState.currentPlayer, dice1 + dice2);
    await handleLanding();
    
    if (!gameState.waitingForPlayer) {
      nextTurn();
    }
  } else {
    // Failed to roll doubles
    player.jailTurns++;
    
    if (player.jailTurns >= 3) {
      // Must pay fine
      if (player.money >= 50) {
        player.money -= 50;
        player.inJail = false;
        player.jailTurns = 0;
        showMessage('3 turns in jail! Forced to pay $50 fine.');
        
        await sleep(1500);
        await movePlayer(gameState.currentPlayer, dice1 + dice2);
        await handleLanding();
        
        if (!gameState.waitingForPlayer) {
          nextTurn();
        }
      } else {
        showMessage('Cannot pay jail fine! Game Over!');
        player.bankrupt = true;
        nextTurn();
      }
    } else {
      showMessage(`Failed to roll doubles. Stay in jail. (${player.jailTurns}/3)`);
      setTimeout(nextTurn, 2000);
    }
  }
  
  updateDisplay();
}

async function tryJailRollCPU() {
  const player = gameState.players[1];
  const dice1 = Math.floor(Math.random() * 6) + 1;
  const dice2 = Math.floor(Math.random() * 6) + 1;
  
  if (dice1 === dice2) {
    player.inJail = false;
    player.jailTurns = 0;
    showMessage(`CPU rolled doubles (${dice1}-${dice2}) and is free!`);
    
    await sleep(1500);
    await movePlayer(1, dice1 + dice2);
    await handleLanding();
    
    if (!gameState.waitingForPlayer) {
      nextTurn();
    }
  } else {
    player.jailTurns++;
    
    if (player.jailTurns >= 3) {
      if (player.money >= 50) {
        player.money -= 50;
        player.inJail = false;
        player.jailTurns = 0;
        showMessage('CPU forced to pay jail fine after 3 turns.');
        
        await sleep(1500);
        await movePlayer(1, dice1 + dice2);
        await handleLanding();
        
        if (!gameState.waitingForPlayer) {
          nextTurn();
        }
      } else {
        showMessage('CPU cannot pay jail fine! CPU loses!');
        player.bankrupt = true;
        nextTurn();
      }
    } else {
      showMessage(`CPU failed to escape jail. (${player.jailTurns}/3)`);
      setTimeout(nextTurn, 2000);
    }
  }
  
  updateDisplay();
}

function nextTurn() {
  // Check for win condition
  if (gameState.players[0].bankrupt) {
    showMessage('CPU Wins! You went bankrupt!');
    return;
  }
  if (gameState.players[1].bankrupt) {
    showMessage('You Win! CPU went bankrupt!');
    return;
  }
  
  // Switch turns
  gameState.currentPlayer = (gameState.currentPlayer + 1) % 2;
  gameState.canRoll = true;
  
  // Update UI
  document.getElementById('rollBtn').disabled = false;
  updateDisplay();
  updateGameInfo();
  
  // CPU turn
  if (gameState.currentPlayer === 1 && !gameState.waitingForPlayer) {
    setTimeout(() => {
      rollDice();
    }, 2000);
  }
}

function updateDisplay() {
  // Update player panels
  document.getElementById('playerMoney').textContent = gameState.players[0].money;
  document.getElementById('cpuMoney').textContent = gameState.players[1].money;
  
  // Count properties
  const playerProps = Object.keys(gameState.players[0].properties).length;
  const cpuProps = Object.keys(gameState.players[1].properties).length;
  
  document.getElementById('playerProps').textContent = playerProps;
  document.getElementById('cpuProps').textContent = cpuProps;
  
  // Update active player
  document.getElementById('playerPanel').classList.toggle('active', gameState.currentPlayer === 0);
  document.getElementById('cpuPanel').classList.toggle('active', gameState.currentPlayer === 1);
}

function updateGameInfo() {
  const current = gameState.players[gameState.currentPlayer];
  let info = `${current.name}'s Turn`;
  
  if (current.inJail) {
    info += ` - In Jail (${current.jailTurns}/3)`;
  } else {
    info += ' - Roll the Dice!';
  }
  
  document.getElementById('gameInfo').textContent = info;
}

function showMessage(text) {
  document.getElementById('messageBox').textContent = text;
  document.getElementById('messageBox').style.display = 'block';
  
  setTimeout(() => {
    document.getElementById('messageBox').style.display = 'none';
  }, 3000);
}

function showRules() {
  showMessage('Roll dice to move around the board. Buy properties and upgrade them to collect rent from opponents!');
}

function exitGame() {
  if (confirm('Are you sure you want to exit?')) {
    window.close();
  }
}

// Initialize
updateDisplay();
updateGameInfo();
</script>
</body>
</html>
