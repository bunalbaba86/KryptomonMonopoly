<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kryptomon Monopoly - Mobile Edition</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
  color: #fff;
  min-height: 100vh;
  overflow-x: hidden;
}

.container {
  max-width: 100%;
  margin: 0 auto;
  padding: 10px;
}

h1 {
  text-align: center;
  color: #00f5ff;
  font-size: clamp(1.5rem, 5vw, 3rem);
  margin-bottom: 20px;
  text-shadow: 0 0 30px #00f5ff;
  animation: titleGlow 2s ease-in-out infinite alternate;
  font-weight: 900;
}

@keyframes titleGlow {
  from { text-shadow: 0 0 30px #00f5ff; }
  to { text-shadow: 0 0 50px #00f5ff; }
}

/* Menu */
.menu {
  text-align: center;
  padding: 40px 20px;
  background: rgba(26, 26, 46, 0.3);
  border-radius: 30px;
  backdrop-filter: blur(10px);
  border: 2px solid rgba(0, 245, 255, 0.3);
}

.menu button {
  background: linear-gradient(45deg, #00f5ff, #0080ff);
  border: none;
  padding: 15px 30px;
  margin: 10px;
  font-size: 16px;
  color: white;
  border-radius: 50px;
  cursor: pointer;
  transition: all 0.4s ease;
  box-shadow: 0 8px 30px rgba(0, 245, 255, 0.4);
  font-weight: bold;
  min-width: 150px;
}

.menu button:hover {
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 15px 40px rgba(0, 245, 255, 0.6);
}

/* Game Layout */
.game-container {
  display: none;
}

.game-layout {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
  max-width: 100%;
}

/* Player Info Section - Center Top */
.player-info-section {
  display: flex;
  gap: 20px;
  justify-content: center;
  align-items: center;
  width: 100%;
  max-width: 600px;
  padding: 15px;
  background: linear-gradient(145deg, rgba(26, 26, 46, 0.9), rgba(22, 33, 62, 0.9));
  border-radius: 25px;
  border: 3px solid rgba(0, 245, 255, 0.3);
  backdrop-filter: blur(15px);
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
}

.player-info {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 15px;
  border-radius: 20px;
  transition: all 0.5s ease;
  min-width: 140px;
  background: rgba(26, 26, 46, 0.5);
  border: 2px solid rgba(0, 245, 255, 0.2);
}

.player-info.active {
  border-color: #00f5ff;
  box-shadow: 0 0 20px rgba(0, 245, 255, 0.5);
  transform: scale(1.05);
}

.player-avatar {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  border: 3px solid #00f5ff;
  background-size: cover;
  background-position: center;
  margin-bottom: 10px;
  box-shadow: 0 0 15px rgba(0, 245, 255, 0.5);
}

.player-avatar.player { background-image: url('character.png'); }
.player-avatar.cpu { background-image: url('character2.png'); }

.player-name {
  font-size: 16px;
  font-weight: bold;
  margin-bottom: 8px;
  color: #00f5ff;
  text-align: center;
}

.player-money {
  font-size: 18px;
  color: #2ed573;
  margin-bottom: 5px;
  font-weight: bold;
  text-align: center;
}

.player-properties {
  font-size: 12px;
  color: #ccc;
  text-align: center;
}

/* Game Board */
.board-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
}

.board {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  grid-template-rows: repeat(5, 1fr);
  gap: 2px;
  width: min(90vw, 500px);
  height: min(90vw, 500px);
  background: linear-gradient(45deg, #0f1419, #1a1a2e);
  border: 4px solid #00f5ff;
  border-radius: 15px;
  padding: 10px;
  box-shadow: 0 0 30px rgba(0, 245, 255, 0.6);
  margin-bottom: 20px;
}

.cell {
  background: linear-gradient(145deg, rgba(26, 26, 46, 0.95), rgba(22, 33, 62, 0.95));
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  padding: 4px;
  position: relative;
  border: 1px solid rgba(0, 245, 255, 0.2);
  transition: all 0.3s ease;
}

.cell.empty {
  background: transparent;
  border: none;
}

.cell:not(.empty):hover {
  border-color: #00f5ff;
  box-shadow: 0 0 15px rgba(0, 245, 255, 0.5);
}

.cell-name {
  font-size: clamp(7px, 2vw, 10px);
  font-weight: bold;
  text-align: center;
  color: #fff;
  line-height: 1.1;
  margin-bottom: 3px;
  text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
}

.cell-rent {
  background: linear-gradient(45deg, #00f5ff, #0080ff);
  color: #000;
  padding: 1px 4px;
  border-radius: 4px;
  font-size: clamp(6px, 1.5vw, 8px);
  font-weight: bold;
  margin-top: auto;
}

.cell-building {
  font-size: clamp(8px, 2vw, 12px);
  margin-top: 1px;
  text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
}

.owner-tag {
  position: absolute;
  top: 2px;
  right: 2px;
  padding: 1px 3px;
  border-radius: 4px;
  font-size: clamp(6px, 1.5vw, 8px);
  font-weight: bold;
}

.owner-player { background: #ff4757; color: #fff; }
.owner-cpu { background: #2ed573; color: #000; }

.player-token {
  position: absolute;
  width: clamp(20px, 5vw, 25px);
  height: clamp(20px, 5vw, 25px);
  border-radius: 50%;
  border: 2px solid #fff;
  transition: all 0.8s ease;
  z-index: 15;
  background-size: cover;
  background-position: center;
  box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
}

.token-player {
  background-image: url('kryptomon.png');
  bottom: 3px;
  left: 3px;
  border-color: #00f5ff;
}

.token-cpu {
  background-image: url('kryptomon2.png');
  bottom: 3px;
  right: 3px;
  border-color: #2ed573;
}

/* START cell special styling */
.cell.start {
  background: linear-gradient(145deg, #32cd32, #228b22) !important;
  color: #fff !important;
  border: 3px solid #32cd32 !important;
  box-shadow: 0 0 20px rgba(50, 205, 50, 1) !important;
}

.cell.start .cell-name {
  color: #fff !important;
  font-size: clamp(8px, 2.5vw, 12px) !important;
  font-weight: 900 !important;
  text-shadow: 0 0 15px rgba(255, 255, 255, 1) !important;
}

.cell.start .player-token {
  border-width: 3px !important;
  box-shadow: 0 0 20px rgba(255, 255, 255, 1) !important;
  z-index: 25 !important;
}

/* Other special cells */
.cell.jail {
  background: linear-gradient(145deg, #dc143c, #b22222);
  color: #fff;
  border-color: #b22222;
}

.cell.tax {
  background: linear-gradient(145deg, #ff69b4, #ff1493);
  color: #fff;
  border-color: #ff1493;
}

.cell.chance {
  background: linear-gradient(145deg, #9932cc, #8b008b);
  color: #fff;
  border-color: #8b008b;
}

/* Dice Section */
.dice-section {
  display: flex;
  gap: 15px;
  align-items: center;
  justify-content: center;
  margin-bottom: 20px;
  padding: 15px;
  background: rgba(26, 26, 46, 0.3);
  border-radius: 20px;
  backdrop-filter: blur(10px);
  border: 2px solid rgba(0, 245, 255, 0.3);
  width: 100%;
  max-width: 400px;
}

.dice {
  width: clamp(50px, 12vw, 60px);
  height: clamp(50px, 12vw, 60px);
  background: linear-gradient(45deg, #00f5ff, #0080ff);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: clamp(20px, 5vw, 24px);
  font-weight: bold;
  color: white;
  cursor: pointer;
  transition: all 0.4s ease;
  box-shadow: 0 6px 20px rgba(0, 245, 255, 0.4);
  border: 2px solid #fff;
}

.dice:hover {
  transform: scale(1.1);
}

.dice.rolling {
  animation: roll 0.6s ease-in-out;
}

@keyframes roll {
  0% { transform: rotate(0deg) scale(1); }
  50% { transform: rotate(180deg) scale(1.2); }
  100% { transform: rotate(360deg) scale(1); }
}

.roll-btn {
  background: linear-gradient(45deg, #ff6b6b, #ff8e53);
  border: none;
  padding: 12px 20px;
  color: white;
  border-radius: 20px;
  font-size: clamp(14px, 3.5vw, 16px);
  cursor: pointer;
  transition: all 0.4s ease;
  box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
  font-weight: bold;
  min-width: 100px;
}

.roll-btn:hover:not(:disabled) {
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 10px 30px rgba(255, 107, 107, 0.6);
}

.roll-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Purchase Panel */
.purchase-panel {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: linear-gradient(145deg, rgba(26, 26, 46, 0.98), rgba(22, 33, 62, 0.98));
  border: 3px solid #00f5ff;
  border-radius: 20px;
  padding: 20px;
  z-index: 2000;
  display: none;
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  backdrop-filter: blur(20px);
  box-shadow: 0 0 50px rgba(0, 245, 255, 0.6);
  text-align: center;
}

.purchase-title {
  font-size: clamp(20px, 5vw, 24px);
  color: #00f5ff;
  margin-bottom: 15px;
  font-weight: bold;
}

.property-details {
  background: rgba(0, 0, 0, 0.4);
  padding: 12px;
  border-radius: 10px;
  margin: 12px 0;
  text-align: left;
  border: 1px solid rgba(0, 245, 255, 0.2);
  font-size: clamp(12px, 3vw, 14px);
}

.upgrade-options {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 10px;
  margin: 15px 0;
}

.upgrade-btn {
  background: linear-gradient(45deg, #ffa500, #ff8c00);
  border: none;
  padding: 12px 8px;
  color: white;
  border-radius: 10px;
  cursor: pointer;
  font-size: clamp(10px, 2.5vw, 12px);
  font-weight: bold;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(255, 165, 0, 0.3);
  min-height: 60px;
}

.upgrade-btn:hover:not(:disabled) {
  transform: scale(1.05);
  box-shadow: 0 6px 20px rgba(255, 165, 0, 0.5);
}

.upgrade-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.hotel-btn {
  background: linear-gradient(45deg, #ff1493, #dc143c);
}

.purchase-from-opponent {
  background: linear-gradient(45deg, #8b00ff, #4b0082);
  grid-column: 1 / -1;
  margin-top: 8px;
}

.skip-btn {
  background: linear-gradient(45deg, #666, #888);
  margin-top: 12px;
  padding: 10px 20px;
  font-size: clamp(14px, 3.5vw, 16px);
  border-radius: 15px;
  border: none;
  color: white;
  cursor: pointer;
  transition: all 0.3s ease;
}

/* Message Box */
.message-box {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: linear-gradient(145deg, rgba(26, 26, 46, 0.98), rgba(22, 33, 62, 0.98));
  border: 3px solid #00f5ff;
  border-radius: 15px;
  padding: 20px 25px;
  color: #fff;
  font-size: clamp(14px, 3.5vw, 16px);
  text-align: center;
  z-index: 2500;
  display: none;
  backdrop-filter: blur(15px);
  box-shadow: 0 0 50px rgba(0, 245, 255, 0.6);
  max-width: 80%;
  width: 300px;
}

/* Game Info */
.game-info {
  text-align: center;
  font-size: clamp(14px, 3.5vw, 18px);
  margin: 15px 0;
  color: #00f5ff;
  font-weight: bold;
  padding: 10px 15px;
  background: rgba(26, 26, 46, 0.3);
  border-radius: 15px;
  border: 2px solid rgba(0, 245, 255, 0.3);
  backdrop-filter: blur(10px);
  max-width: 400px;
  width: 100%;
}

.back-btn {
  background: linear-gradient(45deg, #666, #888);
  border: none;
  padding: 10px 20px;
  color: white;
  border-radius: 15px;
  cursor: pointer;
  margin: 20px auto;
  display: block;
  font-size: clamp(14px, 3.5vw, 16px);
  font-weight: bold;
  transition: all 0.3s ease;
}

.close-btn {
  background: #ff4757;
  border: none;
  padding: 6px 12px;
  color: white;
  border-radius: 8px;
  cursor: pointer;
  float: right;
  margin-bottom: 10px;
  font-weight: bold;
  font-size: clamp(12px, 3vw, 14px);
}

/* Other panels */
.chance-card, .jail-panel {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  border-radius: 20px;
  padding: 25px;
  z-index: 2000;
  display: none;
  width: 90%;
  max-width: 400px;
  text-align: center;
  backdrop-filter: blur(15px);
}

.chance-card {
  background: linear-gradient(145deg, rgba(153, 50, 204, 0.95), rgba(139, 0, 139, 0.95));
  border: 3px solid #ffd700;
  box-shadow: 0 0 50px rgba(255, 215, 0, 0.4);
}

.jail-panel {
  background: linear-gradient(145deg, rgba(220, 20, 60, 0.95), rgba(178, 34, 34, 0.95));
  border: 3px solid #fff;
  box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
  color: #fff;
}

.jail-buttons {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 15px;
  flex-wrap: wrap;
}

.jail-btn {
  background: linear-gradient(45deg, #ffa500, #ff8c00);
  border: none;
  padding: 10px 15px;
  color: white;
  border-radius: 10px;
  cursor: pointer;
  font-size: clamp(12px, 3vw, 14px);
  transition: all 0.3s ease;
  font-weight: bold;
  min-width: 100px;
}

.jail-btn:hover {
  transform: scale(1.05);
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .container {
    padding: 5px;
  }
  
  .player-info-section {
    flex-direction: column;
    gap: 15px;
    padding: 10px;
  }
  
  .player-info {
    min-width: 120px;
    padding: 10px;
  }
  
  .board {
    margin-bottom: 15px;
  }
  
  .dice-section {
    padding: 10px;
    gap: 10px;
  }
  
  .upgrade-options {
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
  }
  
  .jail-buttons {
    flex-direction: column;
    gap: 8px;
  }
}

@media (max-width: 480px) {
  .player-info-section {
    gap: 10px;
  }
  
  .player-info {
    min-width: 100px;
    padding: 8px;
  }
  
  .upgrade-options {
    grid-template-columns: 1fr;
  }
  
  .dice-section {
    flex-direction: column;
    gap: 8px;
  }
}
</style>
</head>
<body>

<div class="container">
  <h1>🐉 KRYPTOMON MONOPOLY 🐉</h1>
  
  <!-- Menu Screen -->
  <div id="menu" class="menu">
    <button onclick="startGame()">🎮 Start Game</button>
    <button onclick="showRules()">📖 How to Play</button>
    <button onclick="exitGame()">❌ Exit</button>
  </div>

  <!-- Game Screen -->
  <div id="game" class="game-container">
    <div class="game-layout">
      <!-- Player Info Section - Center Top -->
      <div class="player-info-section">
        <div id="playerInfo" class="player-info">
          <div class="player-avatar player"></div>
          <div class="player-name">👤 YOU</div>
          <div class="player-money">💰 $<span id="playerMoney">1500</span></div>
          <div class="player-properties">Properties: <span id="playerProps">0</span></div>
        </div>
        
        <div id="cpuInfo" class="player-info">
          <div class="player-avatar cpu"></div>
          <div class="player-name">🤖 CPU</div>
          <div class="player-money">💰 $<span id="cpuMoney">1500</span></div>
          <div class="player-properties">Properties: <span id="cpuProps">0</span></div>
        </div>
      </div>

      <!-- Game Board -->
      <div class="board-container">
        <div id="board" class="board"></div>
        
        <div class="dice-section">
          <div id="dice1" class="dice">1</div>
          <div id="dice2" class="dice">1</div>
          <button id="rollBtn" class="roll-btn" onclick="rollDice()">🎲 ROLL</button>
        </div>

        <div id="gameInfo" class="game-info">Your Turn - Roll the Dice!</div>
      </div>
    </div>

    <button class="back-btn" onclick="backToMenu()">← Back to Menu</button>
  </div>

  <!-- Purchase Panel -->
  <div id="purchasePanel" class="purchase-panel">
    <button class="close-btn" onclick="closePurchasePanel()">✕</button>
    <div class="purchase-title">Property Options</div>
    <div class="property-details">
      <p><strong>Property:</strong> <span id="propertyName">-</span></p>
      <p><strong>Price:</strong> $<span id="propertyPrice">0</span></p>
      <p><strong>Current Rent:</strong> $<span id="currentRentDisplay">0</span></p>
    </div>
    <div class="upgrade-options" id="upgradeOptions">
      <button class="upgrade-btn" id="buyBtn" onclick="buyProperty()">Buy Property<br>$<span id="buyPrice">0</span></button>
      <button class="upgrade-btn" onclick="upgradeProperty(1)">Level 1 🏠<br>$50<br>Rent: $<span id="rent1">0</span></button>
      <button class="upgrade-btn" onclick="upgradeProperty(2)">Level 2 🏠🏠<br>$100<br>Rent: $<span id="rent2">0</span></button>
      <button class="upgrade-btn" onclick="upgradeProperty(3)">Level 3 🏠🏠🏠<br>$150<br>Rent: $<span id="rent3">0</span></button>
      <button class="upgrade-btn" onclick="upgradeProperty(4)">Level 4 🏠🏠🏠🏠<br>$200<br>Rent: $<span id="rent4">0</span></button>
      <button class="upgrade-btn hotel-btn" onclick="buildHotel()">Hotel 🏨<br>$300<br>Rent: $<span id="rentHotel">0</span></button>
      <button class="upgrade-btn purchase-from-opponent" id="purchaseFromOpponent" onclick="purchaseFromOpponent()" style="display: none;">Buy from Opponent<br>$<span id="opponentPrice">0</span></button>
    </div>
    <button class="skip-btn" onclick="skipPurchase()">Skip</button>
  </div>

  <!-- Chance Card -->
  <div id="chanceCard" class="chance-card">
    <h2>🎲 CHANCE 🎲</h2>
    <div id="chanceText"></div>
    <button class="jail-btn" onclick="closeChanceCard()" style="margin-top: 15px;">OK</button>
  </div>

  <!-- Jail Panel -->
  <div id="jailPanel" class="jail-panel">
    <h2>🔒 JAIL 🔒</h2>
    <div id="jailText">You are in jail!</div>
    <div class="jail-buttons">
      <button class="jail-btn" onclick="payJailFine()">Pay $50 Fine</button>
      <button class="jail-btn" onclick="tryJailRoll()">Try Double Roll</button>
    </div>
  </div>

  <!-- Message Box -->
  <div id="messageBox" class="message-box"></div>
</div>

<script>
// Game State
let gameState = {
  currentPlayer: 0,
  players: [
    { 
      name: 'You', 
      money: 1500, 
      position: 0, 
      properties: {}, 
      bankrupt: false, 
      inJail: false, 
      jailTurns: 0,
      jailFreeCard: false
    },
    { 
      name: 'CPU', 
      money: 1500, 
      position: 0, 
      properties: {}, 
      bankrupt: false, 
      inJail: false, 
      jailTurns: 0,
      jailFreeCard: false
    }
  ],
  gameStarted: false,
  canRoll: true,
  lastRoll: [0, 0],
  waitingForPlayer: false
};

// Perfect 5x5 square board (16 positions)
const boardPositions = [
  // Bottom row (0-4)
  { name: 'START', type: 'start', price: 0, baseRent: 0 },
  { name: 'Aelum Valley', type: 'property', price: 100, baseRent: 20 },
  { name: 'CHANCE', type: 'chance', price: 0, baseRent: 0 },
  { name: 'Sha Mountains', type: 'property', price: 120, baseRent: 25 },
  { name: 'JAIL', type: 'jail', price: 0, baseRent: 0 },
  
  // Right column (5-7)
  { name: 'Oura Canyon', type: 'property', price: 140, baseRent: 30 },
  { name: 'TAX', type: 'tax', price: 0, baseRent: 0 },
  { name: 'Ukko Desert', type: 'property', price: 160, baseRent: 35 },
  
  // Top row (8-11)
  { name: 'FREE PARKING', type: 'special', price: 0, baseRent: 0 },
  { name: 'Haamu Peaks', type: 'property', price: 180, baseRent: 40 },
  { name: 'CHANCE', type: 'chance', price: 0, baseRent: 0 },
  { name: 'Bosco Valley', type: 'property', price: 200, baseRent: 45 },
  
  // Left column (12-15)
  { name: 'Mystic Woods', type: 'property', price: 220, baseRent: 50 },
  { name: 'Cryonia', type: 'property', price: 240, baseRent: 55 },
  { name: 'TAX', type: 'tax', price: 0, baseRent: 0 },
  { name: 'Thunder Peak', type: 'property', price: 280, baseRent: 65 }
];

// Reduced chance cards (half rewards)
const chanceCards = [
  { text: "Get out of jail free! Keep this card.", effect: "jailFree" },
  { text: "Collect $100 from bank!", effect: "collect100" },
  { text: "Go to jail! Do not pass START.", effect: "goToJail" },
  { text: "Advance to START! Collect $100.", effect: "goToStart" },
  { text: "Pay $25 tax!", effect: "pay25" },
  { text: "Collect $50 bonus!", effect: "collect50" }
];

function initGame() {
  createBoard();
  updateDisplay();
  updateGameInfo();
}

function createBoard() {
  const board = document.getElementById('board');
  board.innerHTML = '';
  
  // 5x5 grid (25 cells total, 16 used for board)
  for (let i = 0; i < 25; i++) {
    const cell = document.createElement('div');
    cell.className = 'cell';
    
    const boardIndex = getBoardIndex(i);
    
    if (boardIndex !== -1) {
      const position = boardPositions[boardIndex];
      
      if (position.type === 'start') cell.classList.add('start');
      else if (position.type === 'jail') cell.classList.add('jail');
      else if (position.type === 'chance') cell.classList.add('chance');
      else if (position.type === 'tax') cell.classList.add('tax');
      
      cell.innerHTML = `<div class="cell-name">${position.name}</div>`;
      cell.dataset.position = boardIndex;
      
      if (position.type === 'property') {
        const rentDiv = document.createElement('div');
        rentDiv.className = 'cell-rent';
        rentDiv.textContent = `$${position.baseRent}`;
        cell.appendChild(rentDiv);
      }
    } else {
      cell.classList.add('empty');
    }
    
    board.appendChild(cell);
  }
  
  updateTokens();
  updatePropertyDisplay();
}

function getBoardIndex(gridIndex) {
  // Perfect 5x5 square mapping
  const gridToBoardMap = {
    // Bottom row (0-4)
    0: 0, 1: 1, 2: 2, 3: 3, 4: 4,
    // Right column (5-7) 
    9: 5, 14: 6, 19: 7,
    // Top row (8-11)
    24: 8, 23: 9, 22: 10, 21: 11,
    // Left column (12-15)
    20: 12, 15: 13, 10: 14, 5: 15
  };
  
  return gridToBoardMap[gridIndex] || -1;
}

function getGridPosition(boardPosition) {
  const boardToGridMap = {
    0: 0, 1: 1, 2: 2, 3: 3, 4: 4,
    5: 9, 6: 14, 7: 19,
    8: 24, 9: 23, 10: 22, 11: 21,
    12: 20, 13: 15, 14: 10, 15: 5
  };
  return boardToGridMap[boardPosition] || -1;
}

function updateTokens() {
  document.querySelectorAll('.player-token').forEach(token => token.remove());
  
  gameState.players.forEach((player, index) => {
    if (!player.bankrupt) {
      const cell = document.querySelector(`[data-position="${player.position}"]`);
      if (cell) {
        const token = document.createElement('div');
        token.className = `player-token token-${index === 0 ? 'player' : 'cpu'}`;
        cell.appendChild(token);
      }
    }
  });
}

function updatePropertyDisplay() {
  boardPositions.forEach((position, index) => {
    if (position.type === 'property') {
      const cell = document.querySelector(`[data-position="${index}"]`);
      if (cell) {
        // Remove old displays
        const oldOwner = cell.querySelector('.owner-tag');
        const oldBuilding = cell.querySelector('.cell-building');
        const oldRent = cell.querySelector('.cell-rent');
        
        if (oldOwner) oldOwner.remove();
        if (oldBuilding) oldBuilding.remove();
        if (oldRent) oldRent.remove();
        
        const propertyData = getPropertyData(index);
        
        // Add rent display
        const rentDiv = document.createElement('div');
        rentDiv.className = 'cell-rent';
        rentDiv.textContent = `$${calculateRent(index)}`;
        cell.appendChild(rentDiv);
        
        if (propertyData.owner !== undefined) {
          // Add owner tag
          const ownerTag = document.createElement('div');
          ownerTag.className = `owner-tag owner-${propertyData.owner === 0 ? 'player' : 'cpu'}`;
          ownerTag.textContent = propertyData.owner === 0 ? 'P' : 'C';
          cell.appendChild(ownerTag);
          
          // Add building display
          if (propertyData.level > 0) {
            const building = document.createElement('div');
            building.className = 'cell-building';
            if (propertyData.hotel) {
              building.textContent = '🏨';
            } else {
              building.textContent = '🏠'.repeat(propertyData.level);
            }
            cell.appendChild(building);
          }
        }
      }
    }
  });
}

function updateDisplay() {
  // Update player money and properties
  document.getElementById('playerMoney').textContent = gameState.players[0].money;
  document.getElementById('cpuMoney').textContent = gameState.players[1].money;
  
  // Count properties
  const playerProps = Object.keys(gameState.players[0].properties).length;
  const cpuProps = Object.keys(gameState.players[1].properties).length;
  
  document.getElementById('playerProps').textContent = playerProps;
  document.getElementById('cpuProps').textContent = cpuProps;
  
  // Update active player
  const playerInfo = document.getElementById('playerInfo');
  const cpuInfo = document.getElementById('cpuInfo');
  
  if (gameState.currentPlayer === 0) {
    playerInfo.classList.add('active');
    cpuInfo.classList.remove('active');
  } else {
    cpuInfo.classList.add('active');
    playerInfo.classList.remove('active');
  }
  
  updatePropertyDisplay();
}

function updateGameInfo(message = '') {
  const gameInfo = document.getElementById('gameInfo');
  if (message) {
    gameInfo.textContent = message;
  } else {
    const currentPlayerName = gameState.players[gameState.currentPlayer].name;
    gameInfo.textContent = `${currentPlayerName}'s Turn`;
  }
}

function getPropertyData(positionIndex) {
  for (let i = 0; i < gameState.players.length; i++) {
    if (gameState.players[i].properties[positionIndex]) {
      return gameState.players[i].properties[positionIndex];
    }
  }
  return { owner: undefined, level: 0, hotel: false };
}

function calculateRent(positionIndex) {
  const position = boardPositions[positionIndex];
  const propertyData = getPropertyData(positionIndex);
  
  if (propertyData.owner === undefined) {
    return position.baseRent;
  }
  
  let rent = position.baseRent;
  
  if (propertyData.hotel) {
    rent = position.baseRent * 8; // Hotel multiplier
  } else if (propertyData.level > 0) {
    rent = position.baseRent * (1 + propertyData.level); // Level multiplier
  }
  
  return rent;
}

function startGame() {
  document.getElementById('menu').style.display = 'none';
  document.getElementById('game').style.display = 'block';
  gameState.gameStarted = true;
  initGame();
  showMessage('Game Started! Roll the dice to begin!');
}

function backToMenu() {
  document.getElementById('game').style.display = 'none';
  document.getElementById('menu').style.display = 'block';
  resetGame();
}

function resetGame() {
  gameState = {
    currentPlayer: 0,
    players: [
      { 
        name: 'You', 
        money: 1500, 
        position: 0, 
        properties: {}, 
        bankrupt: false, 
        inJail: false, 
        jailTurns: 0,
        jailFreeCard: false
      },
      { 
        name: 'CPU', 
        money: 1500, 
        position: 0, 
        properties: {}, 
        bankrupt: false, 
        inJail: false, 
        jailTurns: 0,
        jailFreeCard: false
      }
    ],
    gameStarted: false,
    canRoll: true,
    lastRoll: [0, 0],
    waitingForPlayer: false
  };
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function showMessage(message) {
  const messageBox = document.getElementById('messageBox');
  messageBox.textContent = message;
  messageBox.style.display = 'block';
  
  setTimeout(() => {
    messageBox.style.display = 'none';
  }, 2500);
}

async function rollDice() {
  if (!gameState.canRoll || gameState.waitingForPlayer) return;
  
  const currentPlayer = gameState.players[gameState.currentPlayer];
  
  if (currentPlayer.inJail) {
    showJailPanel();
    return;
  }
  
  gameState.canRoll = false;
  const dice1 = document.getElementById('dice1');
  const dice2 = document.getElementById('dice2');
  const rollBtn = document.getElementById('rollBtn');
  
  dice1.classList.add('rolling');
  dice2.classList.add('rolling');
  rollBtn.disabled = true;
  
  let d1, d2;
  for (let i = 0; i < 8; i++) {
    d1 = Math.floor(Math.random() * 6) + 1;
    d2 = Math.floor(Math.random() * 6) + 1;
    dice1.textContent = d1;
    dice2.textContent = d2;
    await sleep(100);
  }
  
  gameState.lastRoll = [d1, d2];
  const rollResult = d1 + d2;
  
  dice1.classList.remove('rolling');
  dice2.classList.remove('rolling');
  
  updateGameInfo(`${currentPlayer.name} rolled ${d1} + ${d2} = ${rollResult}`);
  
  await movePlayer(gameState.currentPlayer, rollResult);
  await handleLanding();
  
  if (!gameState.waitingForPlayer) {
    nextTurn();
  }
}

async function movePlayer(playerIndex, steps) {
  const player = gameState.players[playerIndex];
  const startPos = player.position;
  
  for (let i = 0; i < steps; i++) {
    player.position = (player.position + 1) % boardPositions.length;
    updateTokens();
    await sleep(200);
  }
  
  // Check if passed START - reduced to $100
  if (startPos + steps >= boardPositions.length || (startPos > player.position && steps < boardPositions.length)) {
    player.money += 100;
    showMessage(`${player.name} passed START and collected $100!`);
    await sleep(1000);
  }
}

async function handleLanding() {
  const player = gameState.players[gameState.currentPlayer];
  const position = boardPositions[player.position];
  
  updateDisplay();
  
  if (position.type === 'property') {
    await handlePropertyLanding(player, player.position, position);
  } else if (position.type === 'chance') {
    await handleChanceLanding();
  } else if (position.type === 'tax') {
    player.money -= 100;
    showMessage(`${player.name} paid $100 tax!`);
    await sleep(1500);
  }
  
  updateDisplay();
}

async function handlePropertyLanding(player, positionIndex, position) {
  const propertyData = getPropertyData(positionIndex);
  
  if (propertyData.owner === undefined) {
    // Property available for purchase
    if (gameState.currentPlayer === 0) {
      // Human player
      gameState.waitingForPlayer = true;
      showPurchasePanel(positionIndex, position, true);
    } else {
      // CPU player - auto decide (hidden from player)
      if (player.money >= position.price * 1.2) {
        await sleep(1000);
        buyPropertyCPU(positionIndex);
        showMessage(`CPU bought ${position.name} for $${position.price}!`);
        await sleep(2000);
        
        // CPU might upgrade immediately
        if (player.money >= 150 && Math.random() > 0.4) {
          await sleep(500);
          upgradePropertyCPU(positionIndex, 1);
          showMessage(`CPU upgraded ${position.name} to Level 1!`);
          await sleep(1500);
        }
      }
    }
  } else if (propertyData.owner !== gameState.currentPlayer) {
    // Pay rent
    const rent = calculateRent(positionIndex);
    if (player.money >= rent) {
      player.money -= rent;
      gameState.players[propertyData.owner].money += rent;
      showMessage(`${player.name} paid $${rent} rent to ${gameState.players[propertyData.owner].name}!`);
      await sleep(2000);
    } else {
      showMessage(`${player.name} cannot afford rent! Game Over!`);
      player.bankrupt = true;
      await sleep(2000);
    }
  } else {
    // Own property - show upgrade options for human player
    if (gameState.currentPlayer === 0) {
      gameState.waitingForPlayer = true;
      showPurchasePanel(positionIndex, position, false);
    }
  }
}

async function handleChanceLanding() {
  const card = chanceCards[Math.floor(Math.random() * chanceCards.length)];
  const player = gameState.players[gameState.currentPlayer];
  
  document.getElementById('chanceText').textContent = card.text;
  document.getElementById('chanceCard').style.display = 'block';
  
  // Wait for user to close card
  await new Promise(resolve => {
    window.closeChanceCard = () => {
      document.getElementById('chanceCard').style.display = 'none';
      resolve();
    };
  });
  
  // Apply effect (reduced amounts)
  switch (card.effect) {
    case 'jailFree':
      player.jailFreeCard = true;
      break;
    case 'collect100':
      player.money += 100;
      break;
    case 'goToJail':
      player.inJail = true;
      player.position = 4; // Jail position
      player.jailTurns = 0;
      updateTokens();
      break;
    case 'goToStart':
      player.position = 0;
      player.money += 100;
      updateTokens();
      break;
    case 'pay25':
      player.money -= 25;
      break;
    case 'collect50':
      player.money += 50;
      break;
  }
  
  updateDisplay();
}

function showPurchasePanel(positionIndex, position, isAvailable) {
  const panel = document.getElementById('purchasePanel');
  const propertyData = getPropertyData(positionIndex);
  
  document.getElementById('propertyName').textContent = position.name;
  document.getElementById('propertyPrice').textContent = position.price;
  document.getElementById('currentRentDisplay').textContent = calculateRent(positionIndex);
  
  // Calculate rent values for each level
  const baseRent = position.baseRent;
  document.getElementById('rent1').textContent = baseRent * 2;
  document.getElementById('rent2').textContent = baseRent * 3;
  document.getElementById('rent3').textContent = baseRent * 4;
  document.getElementById('rent4').textContent = baseRent * 5;
  document.getElementById('rentHotel').textContent = baseRent * 8;
  
  const upgradeOptions = document.getElementById('upgradeOptions');
  const buyBtn = document.getElementById('buyBtn');
  const purchaseFromOpponent = document.getElementById('purchaseFromOpponent');
  
  // Hide all buttons first
  Array.from(upgradeOptions.children).forEach(btn => btn.style.display = 'none');
  
  if (isAvailable) {
    // Show buy button
    buyBtn.style.display = 'block';
    document.getElementById('buyPrice').textContent = position.price;
    buyBtn.disabled = gameState.players[gameState.currentPlayer].money < position.price;
  } else if (propertyData.owner === gameState.currentPlayer) {
    // Show upgrade options for owned property
    const currentLevel = propertyData.level || 0;
    const hasHotel = propertyData.hotel || false;
    const currentMoney = gameState.players[gameState.currentPlayer].money;
    
    if (!hasHotel) {
      // Show level upgrade buttons
      for (let level = 1; level <= 4; level++) {
        const btn = upgradeOptions.children[level];
        btn.style.display = 'block';
        
        if (level <= currentLevel) {
          btn.disabled = true;
          btn.style.opacity = '0.3';
        } else if (level === currentLevel + 1) {
          btn.disabled = currentMoney < 50 * level;
        } else {
          btn.disabled = true;
          btn.style.opacity = '0.5';
        }
      }
      
      // Show hotel button if level 4
      if (currentLevel >= 4) {
        const hotelBtn = upgradeOptions.children[5];
        hotelBtn.style.display = 'block';
        hotelBtn.disabled = currentMoney < 300;
      }
    }
  } else {
    // Show purchase from opponent option
    purchaseFromOpponent.style.display = 'block';
    const opponentPrice = Math.floor(position.price * 1.5);
    document.getElementById('opponentPrice').textContent = opponentPrice;
    purchaseFromOpponent.disabled = gameState.players[gameState.currentPlayer].money < opponentPrice;
  }
  
  panel.style.display = 'block';
}

function closePurchasePanel() {
  document.getElementById('purchasePanel').style.display = 'none';
  gameState.waitingForPlayer = false;
  nextTurn();
}

function skipPurchase() {
  closePurchasePanel();
}

function buyProperty() {
  const player = gameState.players[gameState.currentPlayer];
  const positionIndex = parseInt(document.querySelector('[data-position]').dataset.position);
  const position = boardPositions[positionIndex];
  
  if (player.money >= position.price) {
    player.money -= position.price;
    player.properties[positionIndex] = {
      owner: gameState.currentPlayer,
      level: 0,
      hotel: false
    };
    
    showMessage(`You bought ${position.name} for $${position.price}!`);
    updateDisplay();
    closePurchasePanel();
  }
}

function buyPropertyCPU(positionIndex) {
  const player = gameState.players[1]; // CPU is player 1
  const position = boardPositions[positionIndex];
  
  player.money -= position.price;
  player.properties[positionIndex] = {
    owner: 1,
    level: 0,
    hotel: false
  };
}

function upgradeProperty(level) {
  const player = gameState.players[gameState.currentPlayer];
  const positionIndex = parseInt(document.querySelector('[data-position]').dataset.position);
  const cost = 50 * level;
  
  if (player.money >= cost && player.properties[positionIndex]) {
    player.money -= cost;
    player.properties[positionIndex].level = level;
    
    showMessage(`Upgraded to Level ${level}!`);
    updateDisplay();
    closePurchasePanel();
  }
}

function upgradePropertyCPU(positionIndex, level) {
  const player = gameState.players[1]; // CPU is player 1
  const cost = 50 * level;
  
  if (player.money >= cost && player.properties[positionIndex]) {
    player.money -= cost;
    player.properties[positionIndex].level = level;
  }
}

function buildHotel() {
  const player = gameState.players[gameState.currentPlayer];
  const positionIndex = parseInt(document.querySelector('[data-position]').dataset.position);
  const cost = 300;
  
  if (player.money >= cost && player.properties[positionIndex] && player.properties[positionIndex].level >= 4) {
    player.money -= cost;
    player.properties[positionIndex].hotel = true;
    
    showMessage(`Built a Hotel!`);
    updateDisplay();
    closePurchasePanel();
  }
}

function purchaseFromOpponent() {
  const player = gameState.players[gameState.currentPlayer];
  const positionIndex = parseInt(document.querySelector('[data-position]').dataset.position);
  const position = boardPositions[positionIndex];
  const cost = Math.floor(position.price * 1.5);
  const propertyData = getPropertyData(positionIndex);
  
  if (player.money >= cost && propertyData.owner !== undefined) {
    player.money -= cost;
    gameState.players[propertyData.owner].money += cost;
    
    // Transfer property
    delete gameState.players[propertyData.owner].properties[positionIndex];
    player.properties[positionIndex] = {
      owner: gameState.currentPlayer,
      level: propertyData.level,
      hotel: propertyData.hotel
    };
    
    showMessage(`Bought ${position.name} from opponent for $${cost}!`);
    updateDisplay();
    closePurchasePanel();
  }
}

function showJailPanel() {
  document.getElementById('jailPanel').style.display = 'block';
}

function payJailFine() {
  const player = gameState.players[gameState.currentPlayer];
  if (player.money >= 50) {
    player.money -= 50;
    player.inJail = false;
    player.jailTurns = 0;
    showMessage(`${player.name} paid $50 and is free!`);
    document.getElementById('jailPanel').style.display = 'none';
    updateDisplay();
    nextTurn();
  } else {
    showMessage('Not enough money!');
  }
}

function tryJailRoll() {
  const dice1Value = Math.floor(Math.random() * 6) + 1;
  const dice2Value = Math.floor(Math.random() * 6) + 1;
  
  document.getElementById('dice1').textContent = dice1Value;
  document.getElementById('dice2').textContent = dice2Value;
  
  const player = gameState.players[gameState.currentPlayer];
  
  if (dice1Value === dice2Value) {
    // Doubles! Free from jail
    player.inJail = false;
    player.jailTurns = 0;
    showMessage(`${player.name} rolled doubles and is free!`);
    document.getElementById('jailPanel').style.display = 'none';
    
    // Move player
    setTimeout(async () => {
      await movePlayer(gameState.currentPlayer, dice1Value + dice2Value);
      await handleLanding();
      if (!gameState.waitingForPlayer) {
        nextTurn();
      }
    }, 1000);
  } else {
    player.jailTurns++;
    if (player.jailTurns >= 3) {
      // Must pay after 3 turns
      showMessage('3 turns in jail! Must pay $50!');
      setTimeout(() => {
        payJailFine();
      }, 1500);
    } else {
      showMessage(`No doubles. ${3 - player.jailTurns} turns left.`);
      document.getElementById('jailPanel').style.display = 'none';
      nextTurn();
    }
  }
  
  updateDisplay();
}

function nextTurn() {
  gameState.currentPlayer = (gameState.currentPlayer + 1) % 2;
  gameState.canRoll = true;
  document.getElementById('rollBtn').disabled = false;
  
  updateDisplay();
  updateGameInfo();
  
  // CPU turn
  if (gameState.currentPlayer === 1 && !gameState.players[1].bankrupt) {
    setTimeout(() => {
      rollDice();
    }, 1500);
  }
}

function showRules() {
  showMessage('Roll dice to move around the board. Buy properties and charge rent. First to bankrupt the opponent wins!');
}

function exitGame() {
  if (confirm('Are you sure you want to exit?')) {
    window.close();
  }
}

// Initialize on load
window.addEventListener('load', () => {
  updateDisplay();
});
</script>
</body>
</html>
